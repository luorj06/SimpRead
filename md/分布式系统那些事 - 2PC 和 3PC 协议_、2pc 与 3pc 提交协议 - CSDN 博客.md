> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [blog.csdn.net](https://blog.csdn.net/u014513883/article/details/80833525)

前言
--

在[分布式系统](https://so.csdn.net/so/search?q=%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F&spm=1001.2101.3001.7020)中，每个节点虽然都能明确知道自己事务操作结果是成功还是失败，但是无法直接获取到其他分布式节点的操作结果。因此，当一个事务操作需要跨越多个分布式节点的时候，为了保持事务处理的 ACID 特性，就需要引入一个称为 “协调者（Coordinator）” 的组件来统一调度所有的分布式节点的执行逻辑，这些被调度的节点称为“参与者（Participant）”。协调者负责调度参与者的行为，并最终决定这些参与者是否要把事务真正进行提交。基于这个思想，衍生出了二阶段提交和三阶段提交两种协议。

2PC 协议
------

### 协议说明

2PC，是 Two-Phase Commit 的缩写，即二阶段提交。

#### 阶段一：提交事务请求

*   **事务询问**
    
    协调者节点向所有参与者节点询问是否可以执行提交操作，并开始等待各参与者节点的响应。
    
*   **执行事务**
    
    参与者节点执行事务操作，并将 Undo 信息和 Redo 信息写入日志。
    
*   **各参与者向协调者反馈事务询问的响应**
    
    参与者根据事务执行与否向协调者发送 Yes 或 No 响应。
    

#### 阶段二：执行事务提交

阶段二会根据上一阶段的反馈来决定是否可以进行事务的提交，分两种情况：

##### 1. 执行事务提交

假如协调者从所有参与者获得的反馈都是 Yes 响应，那么就会执行事务提交。

*   **发送提交请求**
    
    协调者向所有参与者发出 Commit 的请求。
    
*   **事务提交**
    
    参与者接收到 Commit 请求后，正式执行事务提交操作，并在完成后释放在整个事务期间内占用的资源。
    
*   **反馈事务提交结果**
    
    参与者完成事务提交后向协调者发送 Ack 消息。
    
*   **完成事务**
    
    协调者受到所有参与者反馈的 Ack 消息后，完成事务。
    

![](https://i-blog.csdnimg.cn/blog_migrate/d457bdb45181b6e78e760a33ca21bafb.jpeg)

##### 2. 中断事务

假如任何一个参与者向协调者反馈了 No 响应，或者在等待超时之后，协调者无法接收到所有参与者的反馈响应，那么就会中断事务。

*   **发送回滚请求**
    
    协调者向所有参与者发出 Rollback 的请求。
    
*   **事务回滚**
    
    参与者节点利用之前写入的 Undo 信息执行回滚，并释放在整个事务期间内占用的资源。
    
*   **反馈事务回滚结果**
    
    参与者完成事务回滚后向协调者发送 Ack 消息。
    
*   **中断事务**
    
    协调者受到所有参与者反馈的 Ack 消息后，完成事务中断。
    

![](https://i-blog.csdnimg.cn/blog_migrate/fde4dba685c3552cd007325263862bf4.jpeg)

### 优缺点

#### 优点

原理简单，实现方便

#### 缺点

*   **同步阻塞**
    
    在二阶段执行过程中，所有参与该事务的操作逻辑都处于阻塞状态，也就是说各个参与者在等待其他参与者响应的过程中，无法进行其他任何操作，这会极大限制分布式系统的性能。
    
*   **单点故障**
    
    由于协调者的重要性，一旦协调者发生故障，参与者会一直阻塞下去。尤其在第二阶段，协调者发生故障，那么所有的参与者还都处于锁定事务资源的状态中，而无法继续完成事务操作。
    
*   **数据不一致**
    
    在二阶段提交的阶段二中，当协调者向参与者发送 Commit 请求之后，发生了局部网络异常或者在发送 commit 请求过程中协调者发生了故障，这回导致只有一部分参与者接受到了 Commit 请求。而在这部分参与者接到 Commit 请求之后就会执行 Commit 操作。但是其他部分未接到 Commit 请求的机器则无法执行事务提交。于是整个分布式系统便出现了数据部一致性的现象。
    
*   **太过保守**
    
    如果协调者指示参与者进行事务提交询问的过程中，参与者出现故障而导致协调者始终无法获取到所有参与者的响应信息的话，这时协调者只能依靠其自身的超时机制来判断是否需要中断事务，这样的策略显得比较保守。换句话说，二阶段协议没有涉及较为完善的容错机制，任意节点的失败都会导致整个事务的失败。
    

3PC 协议
------

### 协议说明

3PC，是 Three-Phase Commit 的缩写，即三阶段提交，是 2PC 的改进版，将 2PC 的 “提交事务请求”（即 2PC 第一阶段）过程一分为二，形成了由`canCommit`、`preCommit`、`doCommit`三阶段组成的事务处理协议。如下图所示：  
![](https://i-blog.csdnimg.cn/blog_migrate/e949fb0325e4a90a9c7fb91d43d07056.jpeg)

#### 阶段一：canCommit

*   **事务询问**
    
    协调者向参与者发送 canCommit 请求。询问是否可以执行事务提交操作。然后开始等待参与者的响应。
    
*   **响应反馈**
    
    参与者接到 canCommit 请求之后，正常情况下，如果其自身认为可以顺利执行事务，则返回 Yes 响应，并进入预备状态，否则反馈 No。
    

#### 阶段二：preCommit

正常情况下，包含两种可能：

##### 1. 执行事务预提交

*   **发送预提交请求**
    
    协调者向参与者发送 preCommit 请求，并进入 prepared 阶段。
    
*   **事务预提交**
    
    参与者接收到 preCommit 请求后，会执行事务操作，并将 Undo 和 Redo 信息记录到事务日志中。
    
*   **响应反馈**
    
    如果参与者成功的执行了事务操作，则返回 Ack 响应，同时开始等待最终指令：Commit 或 Abort。
    

##### 2. 中断事务

假如任何一个参与者想协调者反馈了 No 响应，或者在等待超时之后，协调者无法接收到所有参与者的反馈响应，那么就会中断事务。

*   **发送中断请求**
    
    协调者向所有参与者发送 Abort 请求。
    
*   **中断事务**
    
    无论是收到来自协调者的 Abort 请求，或是等待协调者请求过程中出现超时，参与者都会中断事务。
    

#### 阶段三：doCommit

同样存在两种情况：

##### 1. 执行提交

*   **发送提交请求**
    
    协调接收到参与者发送的 Ack 响应，那么他将从预提交状态进入到提交状态。并向所有参与者发送 doCommit 请求。
    
*   **事务提交**
    
    参与者接收到 doCommit 请求之后，执行正式的事务提交。并在完成事务提交之后释放所有事务资源。
    
*   **响应反馈**
    
    事务提交完之后，向协调者发送 Ack 响应。
    
*   **完成事务**
    
    协调者接收到所有参与者的 Ack 响应之后，完成事务。
    

##### 2. 中断事务

*   **发送中断请求**
    
    协调者向所有参与者发送 Abort 请求
    
*   **事务回滚**
    
    参与者接收到 Abort 请求之后，利用其在阶段二记录的 Undo 信息来执行事务的回滚操作，并在完成回滚之后释放所有的事务资源。
    
*   **反馈结果**
    
    参与者完成事务回滚之后，向协调者发送 Ack 消息
    
*   **中断事务**
    
    协调者接收到参与者反馈的 Ack 消息之后，执行事务的中断。
    

需要注意的是，一旦进入第三阶段，可能存在以下两种故障：

*   协调者出现问题
*   协调者和参与者之间的网络出现问题

无论哪种情况出现，最终都会导致参与者无法及时接收到来自协调者的 doCommit 或是 abort 请求，针对这样的异常情况，参与者都会在等待超时之后，继续进行事务提交。

### 优缺点

#### 优点

最大优点是降低了参与者的阻塞范围，并且能够在出现单点故障后继续达成一致。

#### 缺点

3PC 在去除阻塞问题的同时引入了新的问题，那就是在参与者接收到 preCommit 消息后，如果网络出现分区，此时协调者所在的节点和参与者无法进行正常的网络通信，在这种情况下，该参与者依然会进行事务的提交，这必然出现数据的不一致性。

参考
--

[1] [《从 PAXOS 到 ZOOKEEPER 分布式一致性原理与实践》](https://book.douban.com/subject/26292004/)

[2] [分布式系统理论基础 - 一致性、2PC 和 3PC](https://www.cnblogs.com/bangerlee/p/5268485.html)